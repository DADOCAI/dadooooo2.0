## 上线总览（你要达到的目标）

* 把前端（Vite 构建好的静态网页）和后端（FastAPI 接口）挂到同一个域名下，全部走 HTTPS

* 浏览器访问你的域名能打开首页，工具页能用，接口稳定，错误有日志，服务器安全

* 支持以后继续更新：我改代码→一键发布→线上自动更新

## 推荐架构（两套选一）

### 方案 A：单机 Nginx + FastAPI（Uvicorn/Gunicorn）

* 场景：快速上线、访问量不大、预算省

* 结构：

  * Nginx：对外入口 + 反向代理 + HTTPS

  * 前端：Nginx直接发静态文件（`/var/www/dadoooo`）

  * 后端：Uvicorn/Gunicorn 启动 FastAPI（监听 `127.0.0.1:8000`），Nginx反代到 `/api`

* 优点：简单、便宜、好维护；缺点：扩展时需要手动迁移

### 方案 B：Docker Compose（Nginx + frontend + backend 容器）

* 场景：后续要扩容/多环境（测试/生产）、需要更标准的运维

* 结构：

  * `nginx` 容器：对外入口 + HTTPS

  * `frontend` 容器：静态站（Nginx或简单 HTTP）

  * `backend` 容器：FastAPI（Uvicorn/Gunicorn）

* 优点：一套脚本就能起停、回滚方便；缺点：初次搭建稍复杂

## 准备清单（你需要准备）

* 域名账号：能改 DNS（例如阿里云/Cloudflare/Namecheap）

* 云服务器：1核2G 或更高（Ubuntu 22.04 推荐），公网 IP（后面我会给你命令）

* 登录方式：SSH（我会把登录安全和防火墙帮你配好）

* 备案：如果国内服务器，需要备案（海外无需）

## 目录结构（线上机器）

* 前端打包产物：`/var/www/dadoooo`（包含 `index.html`、`assets/*`、`ascii/build/*`）

* 后端代码：`/srv/dadoooo/server`（`app.py`、虚拟环境）

* Nginx 配置：`/etc/nginx/sites-available/dadoooo.conf` → 链接到 `sites-enabled`

* 日志：`/var/log/dadoooo/*`（access、error、api）

* 证书：`/etc/letsencrypt/live/<你的域名>/`（自动更新）

## 上线步骤（方案 A 示例）

### 1. 域名与DNS

* 在域名控制台添加 `A` 记录：

  * `@` 指向你的服务器 IP（根域名）

  * `www` 指向同样的 IP（可选）

### 2. 服务器基础安全

* 更新系统、安装必要组件：`sudo apt update && sudo apt upgrade -y`

* 安装：`nginx`、`python3-venv`、`git`、`ufw`（防火墙）

* 防火墙开放：`sudo ufw allow 'Nginx Full' && sudo ufw enable`

* SSH 安全：禁用密码登录，仅密钥（我来改配置）

### 3. 部署前端（静态站）

* 本地运行：`npm run build`（前端根目录）

* 把 `dist`（或 `build`）上传到服务器：`/var/www/dadoooo`

* 你的 ASCII 页面已是静态构建在 `public/ascii/build`，一起随前端产物拷贝（保持路径 `/ascii/build/index.html` 可访问）

### 4. 部署后端（FastAPI）

* 服务器上：

  * `cd /srv/dadoooo/server`

  * 建虚拟环境：`python3 -m venv .venv && source .venv/bin/activate`

  * 安装依赖：`pip install -r requirements.txt`

  * 进程管理：用 `systemd` 写一个服务（开机自启、崩了自动拉起）：

    * 启动命令：`uvicorn server.app:app --host 127.0.0.1 --port 8000 --workers 2`

### 5. 配置 Nginx（一个域名全搞定）

* 核心逻辑：

  * 根路径 `/` → 前端静态站目录

  * `/api` → 反向代理到 `127.0.0.1:8000`

* 文件示例（我来替你写到服务器）：

```
server {
  listen 80;
  server_name yourdomain.com www.yourdomain.com;

  root /var/www/dadoooo;
  index index.html;

  location /api/ {
    proxy_pass http://127.0.0.1:8000/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  location / {
    try_files $uri $uri/ /index.html;
  }
}
```

### 6. HTTPS 证书（Let’s Encrypt 免费）

* 安装：`sudo apt install certbot python3-certbot-nginx`

* 一键：`sudo certbot --nginx -d yourdomain.com -d www.yourdomain.com`

* 自动续期：默认安装好；可测试：`sudo certbot renew --dry-run`

### 7. 验证与回归测试

* 打开：`https://yourdomain.com/`（首页）

* 工具页：`/ascii`、`/cutout`、`/halftone`

* 接口：`/api/health` 200 正常；抠图上传能返回 PNG

* 监控日志：`sudo tail -f /var/log/nginx/access.log /var/log/nginx/error.log`

### 8. 自动化发布（后续迭代更舒服）

* 选一个仓库托管（GitHub/GitLab）

* CI/CD 简化流程：

  * 前端：每次合并 → 自动执行 `npm ci && npm run build` → 打包产物上传服务器目录

  * 后端：每次合并 → 自动 `pip install` → 重启服务（`systemctl restart dadoooo-api`）

* 我可以给你写好 GitHub Actions + 服务器接收发布的脚本（rsync/ssh）

## 运维与稳定性（大白话要点）

* 安全：

  * 所有外部访问走 HTTPS；后端仅本机回环（127.0.0.1），不暴露公网端口

  * 防火墙只开 80/443；SSH 限制登录

* 监控：

  * 日志文件每天轮转；错误异常记到独立文件；接口超时/500 自动报警（我后面接一个简易通知）

* 备份：

  * 前端产物存仓库可随时重发；后端代码仓库备份；用户数据如有（后续）要定期备份

* 性能：

  * 开启 Nginx 压缩与缓存静态资源，首屏更快

  * Uvicorn 多进程（2-4），适配并发

## 特殊点（你的项目）

* ASCII 工具现在是静态构建嵌入 `/ascii`，无需独立服务；保持目录结构即可

* 抠图接口为 `/api/cutout`，首启模型可能稍慢（我会加预热和错误提示）

* 登录/支付还未上线：迭代时，我会在同一域名下 `/api/auth`、`/api/pay` 做统一鉴权与回调

## 备选：Docker Compose（给以后扩容）

* 用 `docker-compose.yml` 定义 `nginx`、`frontend`、`backend` 三个服务

* 好处：一条命令 `docker compose up -d` 起全部；换机器也能一把梭

* 我可以把当前项目改造成容器化版本，保留你的静态目录结构不变

## 你现在需要提供的东西（我来帮你执行）

* 域名（和 DNS 控制台的登录方式）

* 服务器品牌/系统（如果还没买，我给你链接和规格建议）

* 是否需要国内访问更快（CDN 可选：Cloudflare/阿里云 CDN）

## 交付物（我会给你）

* 一套服务器上的目录与配置文件（Nginx、systemd、日志轮转）

* 一个“发布脚本”或 GitHub Actions，让你后续更新只用点一下

* 运维手册（1页），告诉你“出问题怎么查日志和重启”

## 下一步（请确认）

1. 选架构方案：A（快速上线）或 B（Docker Compose）
2. 把你的域名和服务器信息发给我（或让我代买）
3. 我开始远程部署，半天内给你可访问的 HTTPS 站点和发布通道

